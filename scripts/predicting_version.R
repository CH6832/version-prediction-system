# ----------------------------------------------------------------------------------------
# Title:        predicting_version.R
# Date:         2024-10-16
# Description:  Predicting cumulative software version numbers using a pre-trained model.
# Version:      1.0
# 
# © 2024 Christoph Hartleb. All rights reserved.
# 
# This work is licensed under the Creative Commons Attribution-NonCommercial-NoDerivatives
# 4.0 International License. To view a copy of this license, visit
# http://creativecommons.org/licenses/by-nc-nd/4.0/
#
# You are free to:
# - Share — copy and redistribute the material in any medium or format.
#
# Under the following terms:
# - Attribution — You must give appropriate credit, provide a link to the license, and 
#   indicate if changes were made. You may do so in any reasonable manner, but not in any 
#   way that suggests the licensor endorses you or your use.
# - NonCommercial — You may not use the material for commercial purposes.
# - NoDerivatives — If you remix, transform, or build upon the material, you may not 
#   distribute the modified material.
#
# No additional restrictions — You may not apply legal terms or technological measures 
# that legally restrict others from doing anything the license permits.
# ----------------------------------------------------------------------------------------

source("scripts/utils.R")

check_pkg_status(c("jsonlite","ggplot2","dplyr"))

library(jsonlite)
library(ggplot2)
library(dplyr)

# best model usage loaded
model_path <- paste0("models/", best_model_name, "_model.rds")
best_model <- readRDS(model_path)

# load test data
test_data <- read.csv("data/preprocessed/testing_versions.csv")

# make the predictions
predictions <- predict(best_model, newdata = test_data)

# combine actual and predicted values
results <- data.frame(Actual = test_data$cumulative_version, Predicted = predictions)

# calculate RMSE
rmse <- sqrt(mean((results$Actual - results$Predicted) ^ 2))

#' Plot Predicted Results
#'
#' This function creates a scatter plot visualizing the predicted cumulative version
#' against the actual cumulative version values. It includes a reference line where
#' predicted values equal actual values for easy comparison.
#'
#' @return A ggplot object representing the predicted vs actual values.
#' @note This function requires the `results` data frame to be defined in the environment,
#'       containing the columns `Actual` and `Predicted`. It also relies on the `best_model_name`
#'       variable for the plot title.
#' @examples
#' # Assuming `results` and `best_model_name` are defined:
#' plot <- plot_predicted_result()
#' print(plot)
#' @export
plot_predicted_result <- function() {
  # Visualization of predictions vs actual values
  plot <- ggplot(results, aes(x = Actual, y = Predicted)) +
    geom_point() +
    geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
    labs(title = paste("Actual vs Predicted Cumulative Version (Model:", best_model_name, ")"),
         x = "Actual Values",
         y = "Predicted Values") +
    theme_minimal()
  
  return(plot)
}

#' Get Model Predictions
#'
#' This function returns the predicted values from the best-fitted model
#' based on the test data provided. The predictions are generated using the 
#' previously defined `best_model` and `test_data` variables.
#'
#' @return A numeric vector of predicted values generated by the best model.
#' @note Ensure that the `best_model` and `test_data` variables are properly
#'       defined in the environment before calling this function.
#' @examples
#' # Assuming `best_model` and `test_data` are defined:
#' predictions <- get_predictions()
#' print(predictions)
#' @export
get_predictions <- function() {
  
  return(predictions)
}

#' Calculate and Display Root Mean Squared Error (RMSE)
#'
#' This function prints the Root Mean Squared Error (RMSE) for the model's predictions 
#' compared to the actual values. RMSE measures the difference between the values 
#' predicted by the model and the actual values in the dataset.
#'
#' @return A printed message displaying the RMSE value. The function does not return any object.
#' @note Make sure that the variable `rmse` is calculated prior to calling this function. 
#'       RMSE is useful for assessing the performance of regression models.
#' @examples
#' # Assuming the `rmse` value is computed:
#' get_rmse()
#' @export
get_rmse <- function() {
  
  return(cat(paste("Root Mean Squared Error (RMSE):", rmse, "\n")))  
}

#' Display Summary of the Best Model
#'
#' This function prints the summary statistics of the best model that has been fitted to the data.
#' The summary includes details such as the coefficients, residuals, R-squared values, and other 
#' important information for evaluating the model's performance.
#'
#' @return A printed summary of the best model. The function does not return any object.
#' @note Ensure that the variable `best_model` is defined and holds a fitted model object before 
#'       calling this function. The summary function may take time to execute for complex models 
#'       or large datasets.
#' @examples
#' # Assuming `best_model` is defined as a fitted model:
#' get_summary()
#' @export
get_summary <- function() {
  
  return(cat(paste(summary(best_model))))  
}

# Save prediction results to csv file.
write.csv(results, "data/results/predictions_results.csv", row.names = FALSE)


